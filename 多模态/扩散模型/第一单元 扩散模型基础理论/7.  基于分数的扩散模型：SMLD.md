åŸºäºåˆ†æ•°åŒ¹é…éƒä¹‹ä¸‡åŠ¨åŠ›æ–¹ç¨‹çš„æ‰©æ•£æ¨¡å‹ï¼ˆScore-Matching Langevin Dynamicsï¼ŒSMLDï¼‰ä¹Ÿæ˜¯ä¸€ç§ç”¨äºæœºå™¨å­¦ä¹ å’Œç»Ÿè®¡ç‰©ç†é¢†åŸŸçš„æ•°å­¦ç”Ÿæˆæ¨¡å‹ã€‚è¿™ç§æ¨¡å‹ç»“åˆäº†åˆ†æ•°åŒ¹é…å’Œéƒä¹‹ä¸‡åŠ¨åŠ›æ–¹ç¨‹ï¼Œç”¨äºä¼°è®¡æ¦‚ç‡åˆ†å¸ƒçš„æ¢¯åº¦ï¼ˆå³â€œåˆ†æ•°â€ï¼‰ï¼Œå¹¶ä»¥æ­¤æ¥ç”Ÿæˆæ–°çš„æ•°æ®æ ·æœ¬ã€‚åˆ†æ•°åŒ¹é…æ˜¯ä¸€ç§ç»Ÿè®¡æ¨æ–­æ–¹æ³•ï¼Œç”¨äºä¼°è®¡æ¦‚ç‡åˆ†å¸ƒçš„å¯¼æ•°ï¼Œè€Œéƒä¹‹ä¸‡åŠ¨åŠ›æ–¹ç¨‹æ˜¯ä¸€ç§ç‰©ç†æ–¹ç¨‹ï¼Œæè¿°äº†ç²’å­åœ¨éšæœºåŠ›ä½œç”¨ä¸‹çš„è¿åŠ¨ã€‚å°†è¿™ä¸¤ç§æ–¹æ³•ç»“åˆï¼Œå¯ä»¥æœ‰æ•ˆåœ°æ¨¡æ‹Ÿå¤æ‚æ•°æ®åˆ†å¸ƒï¼Œå¹¶åœ¨æœºå™¨å­¦ä¹ ä¸­ç”¨äºç”Ÿæˆæ¨¡å‹ã€‚

è¿™éƒ¨åˆ†å†…å®¹ä¸»è¦æºäºNCSN ï¼ˆNoise Conditional Score Networksï¼‰è®ºæ–‡[2]ï¼Œè¿™æ˜¯å®‹é£å‘è¡¨åœ¨ NeurIPS2019 ä¸Šé¢çš„æ–‡ç« ï¼Œæ¯”DDPMé‚£ç¯‡æ–‡ç« è¿˜è¦æ—©ã€‚å®‹é£åšå£«è®¤ä¸ºç°æœ‰çš„ç”Ÿæˆæ¨¡å‹å¯ä»¥å¤§ä½“åˆ†ä¸ºä¸¤ç§[3]ï¼š**åŸºäºä¼¼ç„¶çš„æ¨¡å‹**ä¸**éšå¼ç”Ÿæˆæ¨¡å‹**ã€‚åŸºäºä¼¼ç„¶çš„æ¨¡å‹è¦ä¹ˆä¸ºä¼¼ç„¶çš„è®¡ç®—å¯¹æ¨¡å‹ç»“æ„åšå¾ˆå¼ºçš„é™åˆ¶ï¼Œè¦ä¹ˆä¾èµ–ç›®æ ‡å‡½æ•°æ¥åšâ€œè¿‘ä¼¼æå¤§ä¼¼ç„¶â€çš„è®­ç»ƒã€‚è€Œéšå¼ç”Ÿæˆæ¨¡å‹è¦æ±‚å¯¹æŠ—è®­ç»ƒï¼Œæ¨¡å‹ä¸ç¨³å®šå¾ˆå®¹æ˜“å´©æºƒã€‚ä¸ºäº†è§„é¿è¿™äº›é—®é¢˜ï¼Œå®‹é£åšå£«é€‰æ‹©ä»å¤§é‡è¢«å™ªå£°æ‰°åŠ¨çš„æ•°æ®åˆ†å¸ƒä¸­å­¦ä¹ åˆ†æ•°å‡½æ•°ï¼ˆscore functionï¼‰ï¼Œå³â€œ**æ–¯å¦å› åˆ†æ•°**ï¼ˆStein scoreï¼‰â€ã€‚å¹¶ä½¿ç”¨æœ—ä¹‹ä¸‡åŠ¨åŠ›å­¦ï¼ˆLangevin dynamicsï¼‰çš„æ–¹æ³•ä»ä¼°è®¡çš„æ•°æ®åˆ†å¸ƒä¸­è¿›è¡Œé‡‡æ ·æ¥ç”Ÿæˆæ–°çš„æ ·æœ¬ã€‚è¿™æ ·å¾—åˆ°çš„ç”Ÿæˆæ¨¡å‹é€šå¸¸ç§°ä¸ºâ€œ**åŸºäºåˆ†æ•°çš„ç”Ÿæˆæ¨¡å‹**â€ï¼ˆScore-based Generative Modelsï¼ŒSGMï¼‰ã€‚æœ¬èŠ‚ä¸æ˜¯è¦è§£æ NCSN è®ºæ–‡ï¼Œè€Œæ˜¯è¦å€Ÿå®‹é£åšå£«çš„è§‚ç‚¹ä»‹ç»â€œåˆ†æ•°ç”Ÿæˆâ€çš„æ¦‚å¿µã€‚

### 7.1 â€œåˆ†æ•°â€çš„èµ·æº
ä¼ ç»Ÿç”Ÿæˆæ¨¡å‹çš„ç›®æ ‡å°±æ˜¯è¦å¾—åˆ°æ•°æ®çš„åˆ†å¸ƒã€‚ä¾‹å¦‚ä¸€ä¸ªæ•°æ®é›† ${x_1, x_2, ..., x_N}$ çš„æ•°æ®çš„æ¦‚ç‡å¯†åº¦åˆ†å¸ƒï¼ˆæ³¨æ„ï¼Œè¿™é‡Œæ˜¯æ¦‚ç‡å¯†åº¦åˆ†å¸ƒï¼ŒPDFï¼‰ä¸º $p(x)$ ã€‚èµ·åˆæˆ‘ä»¬è®¤ä¸ºåˆå§‹çš„æ•°æ®æ˜¯æ‚ä¹±çš„ï¼Œéšæœºçš„ï¼Œæˆ‘ä»¬å¯ä»¥è®°ä¸ºï¼š
$$
p_{\theta}({x}) = \frac{e^{-f_{\theta}({x})}}{C_{\theta}},f_{\theta}({x})\in \mathbb{R} \tag{1.117}\\
$$
$\theta$ æ˜¯å‚æ•°ç”¨äºå»ºæ¨¡ï¼Œ $f_{\theta}$ è¢«ç§°ä¸ºæ ¸å¿ƒèƒ½é‡æ¨¡å‹ï¼ˆenergy-based modelï¼‰ã€‚è¿™ä¸ªå‡½æ•°å‹å°±å¾ˆåƒé«˜æ–¯å‡½æ•° $f(x)=\frac{1}{Ïƒ \sqrt{2Ï€}} \cdot e^{\frac{-(x - Î¼)^2} {2Ïƒ^2}}$ ã€‚æˆ‘ä»¬é¦–å…ˆè®¡ç®—åŸºäº $x$ çš„å¯¼æ•°ä¸ºï¼š
$$
\nabla _{{x}}\log(p_{\theta}({x})) = -\nabla _{{x}}f _{\theta}({x}) - \nabla _{{x}}\log C_{\theta} = -\nabla _{{x}}f _{\theta}({x}) \tag{1.118} \\
$$
è¿™é‡Œ $\nabla _{{x}}\log C_{\theta}=0$ ã€‚å…¬å¼2.2çš„ $-\nabla _{{x}}f _{\theta}({x})$ åœ¨è¿™é‡Œç§°ä¸ºâ€œæ–¯å¦å› åˆ†æ•°â€ï¼ˆStein scoreï¼‰å†ç›¸å…³è®ºæ–‡ä¸­ï¼Œç®€ç§°ä¸ºâ€œåˆ†æ•°â€ï¼ˆscoreï¼‰ã€‚è¿™é‡Œè¦æ˜ç¡®ä¸€ä¸‹ï¼Œæˆ‘ä»¬æ˜¯å¯¹ $x$ æ±‚å¯¼è€Œä¸æ˜¯ç±»ä¼¼äºâ€œæå¤§ä¼¼ç„¶è®¡ç®—å‚æ•°â€çš„å¯¹ $\theta$ æ±‚å¯¼ã€‚å¦‚æœå¯¹ $\theta$ æ±‚å¯¼ï¼Œæˆ‘ä»¬ä¼šå‘ç°åé¢åˆå¤šäº†ä¸€ä¸ªæ›´éš¾æ±‚è§£çš„ $C_\theta$ é¡¹ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œæ›´å…³æ³¨çš„æ˜¯æ•°æ® $x$ é‡‡æ ·ã€‚
å…¶åŸå› è¦ä»â€œåˆ†æ•°â€å…·ä½“æ„ä¹‰è§£é‡Šã€‚ä»æ•°å­¦çš„è§’åº¦å‡ºå‘æ¥çœ‹ï¼Œâ€œåˆ†æ•°â€æ˜¯ä¸€ä¸ªâ€œçŸ¢(å‘)é‡åœºâ€(vector field) ã€‚å‘é‡çš„æ–¹å‘æ˜¯ï¼šå¯¹äºè¾“å…¥æ•°æ®(æ ·æœ¬)æ¥è¯´ï¼Œå…¶å¯¹æ•°æ¦‚ç‡å¯†åº¦å¢é•¿æœ€å¿«çš„æ–¹å‘ã€‚å¦‚æœåœ¨é‡‡æ ·è¿‡ç¨‹ä¸­æ²¿ç€åˆ†æ•°çš„æ–¹å‘èµ°ï¼Œå°±èƒ½å¤Ÿèµ°åˆ°æ•°æ®åˆ†å¸ƒçš„é«˜æ¦‚ç‡å¯†åº¦åŒºåŸŸï¼Œæœ€ç»ˆç”Ÿæˆçš„æ ·æœ¬å°±ä¼šç¬¦åˆåŸæ•°æ®åˆ†å¸ƒã€‚ç”±æ­¤å¯çŸ¥ï¼Œä¹‹æ‰€ä»¥æˆ‘ä»¬æ›´å…³æ³¨æ•°æ® $x$ é‡‡æ ·ï¼Œæ˜¯å› ä¸ºï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é‡‡æ ·ï¼Œè®©æ ·æœ¬åˆ†å¸ƒæ›´è¶‹è¿‘äºâ€œçŸ¢(å‘)é‡åœºâ€åˆ†å¸ƒã€‚
ç°åœ¨æˆ‘ä»¬æƒ³è¦è®­ç»ƒä¸€ä¸ªç¥ç»ç½‘ç»œæ¥ä¼°è®¡å‡ºâ€œåˆ†æ•°â€çš„åˆ†å¸ƒã€‚å‡è®¾ç”¨ $s_\theta({x})$ è®­ç»ƒç¥ç»ç½‘ç»œçš„åˆ†æ•°ï¼ŒåŒç† $\theta$ æ˜¯ä»£è¡¨ç¥ç»ç½‘ç»œã€‚æˆ‘ä»¬å¯ä»¥è·ç¦»L2æŸå¤±å‡½æ•°æ¥æœ€å°åŒ–çœŸå®çš„score functionï¼Œå¦‚ä¸‹ï¼š
$$\mathcal{Loss} = \mathbb{E}_{p({x})}[||\nabla _{{x}}\log p_\theta({x}) - {s} _{\theta}({x})||^{2}] \tag{1.119}$$
åå‘æ¢¯åº¦æ›´æ–°ç¥ç»ç½‘ç»œ $\theta$ æƒé‡ã€‚è¿™ç§æ±‚è§£æ–¹æ¡ˆå¯ä»¥å«**æ˜¾å¼åˆ†æ•°åŒ¹é…æŸå¤±**ï¼ˆESMï¼‰ï¼ŒåŠ äº†â€æ˜¾å¼â€œäºŒå­—å°±æ˜¯ä¸ºäº†ä¸åé¢æ›´å¸¸ç”¨çš„â€œ**å»å™ªåˆ†æ•°åŒ¹é…**â€ï¼ˆDSMï¼‰åŒºåˆ†ã€‚
### 7.2  åŸºäºåˆ†æ•°çš„æ‰©æ•£æ¨¡å‹
#### 7.2.1  éƒä¹‹ä¸‡åŠ¨åŠ›å­¦é‡‡æ ·æ–¹æ³•
ä¸Šé¢å…³äºåˆ†æ•°çš„è§£é‡Šæ˜¯é€šç”¨çš„è¯´æ³•ï¼Œæˆ‘ä»¬åœ¨è¿™ä¸Šé¢åŠ ä¸Šæ¡ä»¶ï¼Œè€ƒè™‘ä¸€ä¸ªä¸æ–­åœ°åšå¸ƒæœ—è¿åŠ¨çš„åˆ†å¸ƒï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•æ¨¡ä»¿å…¶è¿‡ç¨‹ï¼Ÿè¿™å°±æ¶‰åŠåˆ°æè¿°ç‰©ç†å­¦ä¸­å¸ƒæœ—è¿åŠ¨ï¼ˆæ‚¬æµ®åœ¨æ¶²ä½“æˆ–æ°”ä½“ä¸­çš„å¾®å°é¢—ç²’æ‰€åšçš„æ— è§„åˆ™è¿åŠ¨ï¼‰çš„å¾®åˆ†æ–¹ç¨‹**æœ—ä¹‹ä¸‡åŠ¨åŠ›å­¦**ï¼ˆLangevin dynamicsï¼‰æ–¹ç¨‹ã€‚
æ¦‚æ‹¬åœ°æ¥è¯´ï¼Œè¯¥æ–¹æ³•é¦–å…ˆä»å…ˆéªŒåˆ†å¸ƒéšæœºé‡‡æ ·ä¸€ä¸ªåˆå§‹æ ·æœ¬ï¼Œç„¶ååˆ©ç”¨æ¨¡å‹ä¼°è®¡å‡ºæ¥çš„åˆ†æ•°é€æ¸å°†æ ·æœ¬å‘æ•°æ®åˆ†å¸ƒçš„é«˜æ¦‚ç‡å¯†åº¦åŒºåŸŸé è¿‘ã€‚ä¸ºä¿è¯ç”Ÿæˆç»“æœçš„å¤šæ ·æ€§ï¼Œæˆ‘ä»¬éœ€è¦é‡‡æ ·è¿‡ç¨‹å¸¦æœ‰éšæœºæ€§ã€‚å½“ç»è¿‡ä¸­æ‰€è¿°çš„åˆ†æ•°åŒ¹é…æ–¹æ³•è®­ç»ƒæ·±åº¦ç”Ÿæˆæ¨¡å‹åï¼Œå¯ä»¥ä½¿ç”¨å…·æœ‰è¿­ä»£è¿‡ç¨‹çš„æœ—ä¹‹ä¸‡åŠ¨åŠ›å­¦é‡‡æ ·æ–¹æ³•ä»åˆ†å¸ƒä¸­æ¥ç”Ÿæˆæ–°çš„æ ·æœ¬ã€‚
æœ—ä¹‹ä¸‡åŠ¨åŠ›å­¦æ¨ç†è¿‡ç¨‹å¾ˆå¤æ‚ï¼Œä¸”å±äºç‰©ç†çš„çŸ¥è¯†ï¼Œè¿™é‡Œä¸å†è¿‡å¤šæè¿°ã€‚é‡‡æ ·è¿‡ç¨‹æè¿°ï¼šå‡è®¾åˆå§‹æ•°æ®æ»¡è¶³å…ˆéªŒåˆ†å¸ƒÂ $x_0 \sim \pi(x)$ ï¼Œç„¶åä½¿ç”¨è¿­ä»£è¿‡ç¨‹
$$
\begin{align*}
x_{t+1}&=x_t+\frac{\epsilon}{2}\nabla _{x}\log  p\left( x \right) +\sqrt{\epsilon}\boldsymbol{z}_t, t=0,1,2,\cdots ,T\\
&=x_t+{\tau}\nabla _{x}\log  p\left( x \right) +\sqrt{2\tau}\boldsymbol{z}_t, t=0,1,2,\cdots ,T \tag{1.120}\\
\end{align*}
$$
å½“ $\frac{\epsilon}{2}=\tau$ æ—¶ä¸Šé¢çš„å…¬å¼ç­‰ä»·ã€‚å…¶ä¸­ï¼Œ $z_i \sim \mathcal{N}(0,I)$ ä¸ºæ ‡å‡†é«˜æ–¯åˆ†å¸ƒï¼Œå¯ä»¥çœ‹æˆæ˜¯å™ªå£°çš„æ¦‚å¿µï¼Œ$\epsilon,\tau$ æ˜¯å¯ä»¥çœ‹æˆæ­¥é•¿ã€‚è™½ç„¶ç‰©ç†å®šä¹‰ä¸åŒï¼Œä½†â€œæœ—ä¹‹ä¸‡åŠ¨åŠ›å­¦å…¬å¼â€æœ¬è´¨ä¸â€œéšæœºæ¢¯åº¦ä¸‹é™â€ï¼Œâ€œæ³°å‹’å…¬å¼å±•å¼€â€å®é™…ä¸Šæ˜¯åŒæºçš„ã€‚ä¾‹å¦‚æˆ‘ä»¬åœ¨é«˜ç­‰æ•°å­¦ä¸­å­¦åˆ°çš„æ³°å‹’å±•å¼€å…¬å¼å¦‚ä¸‹ï¼š
$$
\begin{align}
f(x+\epsilon)=f(x)+f^{'}(x)\epsilon+\frac{1}{2}f^{''}(x)\epsilon^2+o(\epsilon^3)
\end{align}
$$
å†çœ‹â€œæ¢¯åº¦ä¸‹é™â€çš„å…¬å¼ï¼š
$$\begin{align}
f(k-\epsilon) = f(k) - \epsilon * f'(k) \\
x_{k+1} = x_k - \epsilon*f'(k)
\end{align}$$
ä¸ºäº†é€‚é…â€œæ¢¯åº¦ä¸‹é™â€è´Ÿæ¢¯åº¦æ±‚æœ€å°å€¼çš„é€»è¾‘ï¼Œè¿™é‡Œçš„ $\epsilon$ æ˜¯ä¸ªè´Ÿå€¼ã€‚ä½†æ˜¯è¿™å¹¶ä¸å¦è®¤â€œæ³°å‹’å…¬å¼å±•å¼€â€åŒæºçš„æ¦‚å¿µã€‚ä¸ºä»€ä¹ˆæ€»æ˜¯â€œæ³°å‹’å…¬å¼å±•å¼€â€åœ¨èµ·å…³é”®ä½œç”¨ï¼Ÿå…¶æœ¬è´¨åœ¨äºæ³°å‹’å…¬å¼æ˜¯åœ¨ä¸€æ­¥æ­¥é è¿‘æå€¼ï¼Œä¸”è¶Šé è¿‘æå€¼ï¼Œæ¢¯åº¦è¶Šç­‰äº0è¶Šä¸æ›´æ–°ã€‚æ‰€ä»¥ä»¥åæˆ‘ä»¬åœ¨æå€¼é™„è¿‘è€ƒè™‘é—®é¢˜æ—¶ï¼Œå¯ä»¥ä¼˜å…ˆè€ƒè™‘â€œæ³°å‹’å…¬å¼å±•å¼€â€æ–¹æ¡ˆã€‚
å› ä¸ºæœ‰ $\sqrt{2\tau}z_t$ é¡¹çš„ä½œç”¨ï¼Œâ€œæœ—ä¹‹ä¸‡åŠ¨åŠ›å­¦å…¬å¼â€ä¸æ˜¯ç´§è´´æå€¼é‡‡æ ·ï¼Œè€Œæ˜¯åœ¨æå€¼é™„è¿‘é‡‡æ ·ï¼›è€Œä¸”ç”±äº $z_t$ çš„éšæœºä½œç”¨ï¼Œé‡‡æ ·ä¼šéšæœºçš„èšåˆåœ¨æå€¼é™„è¿‘ã€‚è¿™ç§éšæœºä½œç”¨ä¹Ÿå¯¼è‡´äº†å·²çŸ¥çš„å½“å‰çŠ¶æ€ä¸æœªæ¥æˆ–è¿‡å»çš„çŠ¶æ€éƒ½æ— å…³ï¼Œè¿™æ˜¯å…¸å‹çš„é©¬å°”å¯å¤«æ€§ã€‚ä¸‹å›¾æ˜¯æ¨¡æ‹Ÿâ€œéƒä¹‹ä¸‡åŠ¨åŠ›è¿‡ç¨‹â€åœ¨ä¸¤ä¸ªé«˜æ–¯åˆ†å¸ƒä¸­é‡‡æ ·çš„ç»“æœã€‚ç»“åˆå…¬å¼ï¼ˆ1.120ï¼‰ä¸­ï¼Œå½“ $t \rightarrow \infty$ æ—¶ï¼Œ$\epsilon \rightarrow 0$ ï¼Œæœ€ç»ˆç”Ÿæˆçš„æ ·æœ¬Â $x_t$ å°†ä¼šæœä»åŸæ•°æ®åˆ†å¸ƒÂ $q_{data}(x)$ï¼Œè¶‹äºæŸä¸€ä¸ªç‰¹å®šå€¼ã€‚è¿™è¯´æ˜æ‰©æ•£è¿‡ç¨‹æ˜¯æ”¶æ•›çš„é©¬å°”å¯å¤«è¿‡ç¨‹ï¼Œæ•´ä½“æ”¶æ•›äºçš„é‡‡æ ·åˆ†å¸ƒã€‚
![](../images/1.16.jpg)
ï¼ˆä»å·¦åˆ°å³ï¼Œå›¾ç‰‡æ¨¡æ‹Ÿçš„æ˜¯ä½¿ç”¨â€œéƒä¹‹ä¸‡åŠ¨åŠ›å­¦â€åœ¨ä¸¤ä¸ªé«˜æ–¯åˆ†å¸ƒä¸­é‡‡æ ·ï¼Œæœ€åé‡‡æ ·çš„ç»“æœï¼ˆå³å›¾ï¼‰å¾ˆç¬¦åˆåŸå§‹ä¸¤ä¸ªå³°å€¼çš„é«˜æ–¯åˆ†å¸ƒï¼‰

> [!Note]
> å½“å‰ï¼Œäº§ç”Ÿäº†ä¸€ä¸ªæƒ³æ³•ã€‚ä¸åŸºäºå™ªå£°çš„æ‰©æ•£æ¨¡å‹ç±»ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥è®¾æƒ³å°†â€œéƒä¹‹ä¸‡åŠ¨åŠ›å­¦â€å…¬å¼ä¸­æ‰€æè¿°çš„ç‰©ä½“é€æ­¥è¿›è¡Œçš„å¸ƒæœ—è¿åŠ¨è¿‡ç¨‹ï¼Œè§†ä½œä»â€œå›¾ç‰‡åˆ°å™ªå£°â€çš„é€æ­¥æ‰©æ•£è¿‡ç¨‹ã€‚

#### 7.2.2 åŸºäºåŠ å™ªåˆ†æ•°ä¼˜åŒ–çš„éƒä¹‹ä¸‡åŠ¨åŠ›æ–¹ç¨‹
å‰é¢çš„æƒ³æ³•å°†â€œéƒä¹‹ä¸‡åŠ¨åŠ›å­¦â€å…¬å¼ä¸­æè¿°ç‰©ä½“ä¸€æ­¥ä¸€æ­¥çš„å¸ƒæœ—è¿åŠ¨è¿‡ç¨‹ä½œä¸ºä»â€œå›¾ç‰‡åˆ°å™ªå£°â€çš„ä¸€æ­¥ä¸€æ­¥æ‰©æ•£è¿‡ç¨‹â€œã€‚åœ¨NCSNè®ºæ–‡é‡Œé¢æœ‰é›†ä¸­ä½“ç°ã€‚ä½œè€…å°†æ¯ä¸€æ­¥ $x$ é‡‡æ ·åŠ ä¸Šä¸åŒçš„å™ªå£° $\sigma$ï¼Œæ¥æ¨¡æ‹Ÿæ¯ä¸€æ­¥çš„è¿‡ç¨‹ã€‚åœ¨ä¸€æ­¥å¸ƒæœ—è¿åŠ¨ä¸­ï¼Œæˆ‘ä»¬ä»æ ‡å‡†é«˜æ–¯åˆ†å¸ƒ $\mathcal{N}(0,ğ¼)$ ä¸­é‡‡æ ·éšæœºå™ªå£°ğœ–ï¼Œç„¶åä¹˜ä¸Šæˆ‘ä»¬é¢„å®šä¹‰çš„ $ğœ$ ï¼Œæ¥ç€åŠ åˆ°æ ·æœ¬ $ğ‘¥$ ä¸­ï¼Œä»è€Œå°±èƒ½å¾—åˆ°åŠ å™ªåçš„æ ·æœ¬ $\tilde{x}=x+\sigma\epsilon$ã€‚è¿™æ ·â€œå¢å™ªâ€æœ‰ä¸¤ä¸ªå¥½å¤„ï¼š
- å¯¹å¸ƒæœ—è¿åŠ¨çš„è¿‡ç¨‹è¿›è¡Œäº†æ¨¡æ‹Ÿï¼Œåœ¨æ€è·¯æ–¹é¢ä¸â€œåŸºäºå™ªå£°çš„æ‰©æ•£æ¨¡å‹â€è¾¾æˆäº†ç­‰åŒã€‚åœ¨ä¸‹æ–‡å½“ä¸­ï¼Œæˆ‘ä»¬å°†ä¼šå¯¹ä¸¤è€…çš„å…³ç³»äºˆä»¥ä»‹ç»ã€‚
- è§£å†³ä½æ¦‚ç‡å¯†åº¦åŒºåŸŸ score ä¼°è®¡ä¸å‡†ç¡®çš„é—®é¢˜ï¼ŒåŒæ—¶äº¦è§£å†³äº†æ¨¡å‹ä¸æ˜“æ”¶æ•›çš„é—®é¢˜ã€‚ï¼ˆæ­¤ç§åˆ†å¸ƒå¯¹äº VAE äº¦å­˜åœ¨åŒæ ·é—®é¢˜ã€‚ï¼‰è¿™ä¸ªé—®é¢˜çš„èµ·æºäºåˆå§‹çŠ¶æ€æ²¡æœ‰è¦†ç›–æ•´å¹…å›¾ç‰‡ï¼Œæœ€ç»ˆé™·å…¥å±€éƒ¨æœ€ä¼˜ï¼Œä»»åŠ¡å¤±è´¥ã€‚åŒæ—¶ï¼Œå®‹é£åšå£«ä¸¾ä¸€ä¾‹å­ï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ï¼ŒåŠ å…¥å™ªå£°åï¼Œé‡‡æ ·é€‰ä¸­çš„å‡ ç‡å°†å¤§å¤§å¢åŠ ï¼Œä½™ä¸‹çš„åˆ™ä¸ºå¹³æ»‘ç§»åŠ¨çš„é—®é¢˜ã€‚
![](../images/1.17.png)
	ï¼ˆåŸå›¾å¢åŠ å™ªå£°åï¼Œé‡‡æ ·é€‰ä¸­çš„å‡ ç‡ä¼šå¤§å¤§å¢åŠ ï¼Œè“è‰²ä¸ºé‡‡æ ·å‘½ä¸­çš„åŒºåŸŸï¼Œå‰©ä¸‹çš„äº‹æƒ…å°±æ˜¯æœ€å°åŒ–çš„æ“ä½œäº†ã€‚ å›¾ç‰‡æ¥è‡ªå®‹é£åšå®¢ï¼ˆhttps://yang-song.net/blog/2021/score/ï¼‰ï¼‰
> [!Note]
> æé—®ï¼šä¸å¢å™ªå¯ä¸å¯ä»¥?
> ç­”ï¼šç†è®ºä¸Šè™½å…·æœ‰å¯è¡Œæ€§ï¼Œä½†ä¼šè‡´ä½¿å¾ˆå¤šåŒºé—´é‡‡æ ·ä¸åˆ°ï¼Œç»“æœæœ‰æå¤§çš„ä¸å‡†ç¡®æ€§ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åœ¨åç»­çš„è€ƒè™‘ä¸­å‡é‡‡ç”¨åŠ å™ªå…¬å¼ã€‚

æˆ‘ä»¬æ„å»ºæ–°åˆ†å¸ƒä¸ºï¼š
$$\begin{align}
q_{\sigma}(\tilde{x}) &=\int q_Ïƒ(\tilde{x}|x) q_{data}(x) dx \tag{1.121} \\
& = \int \mathcal{N}(\tilde{x}|x,Ïƒ^2I)q_{data}(x) dx \tag{1.122}\\
\text{and} ~ \tilde{x}&=x+\sigma\epsilon, ~ \epsilon\sim \mathcal{N}(0,I) \tag{1.123} \\
\end{align}$$
ä¸Šå¼ä¸­ï¼Œ$x$ ä»£è¡¨åŸå§‹å›¾ç‰‡ï¼Œ$\tilde{x}$ ä»£è¡¨åŠ è½½åçš„å›¾ç‰‡å…¬å¼ï¼ˆ1.121ï¼‰çš„ç§¯åˆ†æ˜¯ä»£è¡¨é‡‡æ ·ï¼Œæœ‰äº›åœ°æ–¹ä¼šçœ‹åˆ°å…¬å¼ï¼ˆ1.122ï¼‰çš„å½¢å¼ï¼ŒæŠŠå¼•å…¥å™ªå£°çš„ $\sigma$ æ˜ç¡®è¡¨ç¤ºå‡ºæ¥ã€‚**æˆ‘ä»¬çŸ¥é“ $q_{data}$ å‡½æ•°å…¶å®å°±æ˜¯ $q_Ïƒ$ ï¼Œåªä¸è¿‡æ˜¯é€šè¿‡åˆ†å¸ƒé‡‡æ ·å¾—åˆ°å‡½æ•°ã€‚** $q_{data}(x)$ ä»£è¡¨éœ€è¦åŸå§‹æ•°æ®çš„åˆ†å¸ƒã€‚$q_Ïƒ(\tilde{x}|x) \sim \mathcal{N}(\tilde{x}|x,Ïƒ^2I)$ è¡¨ç¤ºåŠ å™ªæ‰°åŠ¨æ•°æ®åˆ†å¸ƒã€‚$q_{\sigma}(\tilde{x})$ å°±æ˜¯æˆ‘ä»¬æ„å»ºçš„æ–°åˆ†å¸ƒã€‚
> [!Note]
> è¯´æ˜ï¼šå®‹é£åšå£«åœ¨è®ºæ–‡ä¸blogæœ‰ä¸åŒçš„æ ‡è®°æ–¹æ³•ã€‚è®ºæ–‡ç”¨çš„æ˜¯ $q_{\sigma}(x)$ ï¼Œä»£è¡¨ä¸ $p(x)$ ä¸åŒï¼›blogä¸Šç”¨çš„æ˜¯ $p_{\sigma}(x)$ ï¼Œä¸ºäº†åœ¨åé¢ä»å…¬å¼ä¸Šç›´æ¥æ›¿æ¢ $q_{data}(x)$ ã€‚ä¸¤è€…éƒ½æ²¡æœ‰é”™ï¼Œå°±æ˜¯è§£é‡Šä¸åŒã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å…ˆä¸ç”¨çœ‹é‡ $q$ï¼Œ$p$è¿‡ç¨‹åŒºåˆ«ã€‚

NCSNæœ¬è´¨ä¸Šè¿˜æ˜¯ä¸ªåŸºäºåˆ†æ•°ä¼˜åŒ–çš„æ¨¡å‹ã€‚æŒ‰ç…§å…¬å¼ï¼ˆ1.119ï¼‰çš„å†™æ³•ï¼Œè¿™é‡Œæ˜¯è®­ç»ƒä¸€ä¸ªæ¡ä»¶åˆ†æ•°ç½‘ç»œÂ $s_{\theta}( \tilde{x},\sigma )$Â æ¥ä¼°è®¡æ‰°åŠ¨æ•°æ®çš„åˆ†å¸ƒï¼Œå³Â 
$$
\frac{1}{2}\mathbb{E}_{q_Ïƒ(\tilde{x})}
\Big[\Vert s_{\theta}( \tilde{x},\sigma ) - \nabla _{\tilde{x}} \log q_Ïƒ(\tilde{x})\Vert_2^2\Big] \tag{1.124}
$$
æˆ‘ä»¬ä¾æ®DSMè®ºæ–‡[4]ï¼Œå¾—åˆ°ä»¥ä¸‹çš„æ¨å¯¼å…¬å¼
$$
\begin{align}
& ~~~~ \frac{1}{2}\mathbb{E}_{q_Ïƒ(\tilde{x})}
\Big[\Vert s_{\theta}( \tilde{x},\sigma ) - \nabla _{\tilde{x}} \log q_Ïƒ(\tilde{x})\Vert_2^2\Big] \tag{1.125} \\
&=\frac{1}{2}\int {q_Ïƒ(\tilde{x})}
\Big[\Vert s_{\theta}( \tilde{x},\sigma ) - \frac{1}{q_Ïƒ(\tilde{x})}\frac{\partial q_Ïƒ(\tilde{x})}{\partial \tilde{x}} \Vert_2^2\Big] d\tilde{x}\\
&=\frac{1}{2}\int 
\Big[\Vert {q_Ïƒ(\tilde{x})}s_{\theta}( \tilde{x},\sigma ) - \frac{\partial q_Ïƒ(\tilde{x})}{\partial \tilde{x}} \Vert_2^2\Big] d\tilde{x}\\
&=\frac{1}{2}\int 
\Big[\Vert {q_Ïƒ(\tilde{x})}s_{\theta}( \tilde{x},\sigma ) - \frac{\partial \int q_Ïƒ(\tilde{x}|x) q_Ïƒ(x) dx}{\partial \tilde{x}} \Vert_2^2\Big] d\tilde{x} \\
&=\frac{1}{2}\int 
\Big[\Vert {q_Ïƒ(\tilde{x})}s_{\theta}( \tilde{x},\sigma ) - \int \frac{\partial q_Ïƒ(\tilde{x}|x)}{\partial \tilde{x}} q_Ïƒ(x) dx \Vert_2^2\Big] d\tilde{x} \\
&=\frac{1}{2}\int 
\Big[\Vert {\int q_Ïƒ(\tilde{x}|x) q_Ïƒ(x) dx} \cdot s_{\theta}( \tilde{x},\sigma ) - \int q_Ïƒ(\tilde{x}|x) q_Ïƒ(x)\frac{\partial \log q_Ïƒ(\tilde{x}|x)}{\partial \tilde{x}} dx \Vert_2^2\Big] d\tilde{x} \\
&=\frac{1}{2}\int_{\tilde{x}} \int_x q_Ïƒ(\tilde{x}|x) q_Ïƒ(x) 
\Big[\Vert s_{\theta}( \tilde{x},\sigma ) - \frac{\partial \log q_Ïƒ(\tilde{x}|x)}{\partial \tilde{x}}\Vert_2^2\Big] dx d\tilde{x} \\
&= \frac{1}{2}\mathbb{E}_{q_Ïƒ(\tilde{x}|x) q_Ïƒ(x) }
\Big[\Vert s_{\theta}( \tilde{x},\sigma ) - \nabla _{\tilde{x}} \log q_Ïƒ(\tilde{x}|x)\Vert_2^2\Big] \tag{1.126}
\end{align}
$$
å…¬å¼ï¼ˆ1.126ï¼‰å°±æ˜¯å»å™ªå£°åˆ†æ•°åŒ¹é…ï¼ˆDenoising Score Matchingï¼ŒDSMï¼‰çš„æŸå¤±å‡½æ•°ã€‚æ•´ä¸ªæ¨ç†è¿‡ç¨‹çœ‹èµ·æ¥æ¯”è¾ƒæ— èŠï¼Œä½†çš„ç¡®å‘Šè¯‰äº†æˆ‘ä»¬æŸå¤±å‡½æ•°çš„è§£æ³•ã€‚å»å™ªåˆ†æ•°åŒ¹é…æ–¹æ³•æ˜¯åœ¨è®¡ç®—å™ªå£°æ¡ä»¶åˆ†æ•°ç½‘ç»œï¼ˆNCSNï¼‰ ä¸­é»˜è®¤çš„è®¡ç®—æ–¹æ³•[3]ã€‚
è¿™é‡Œé¢è¿˜æœ‰ä¸€ä¸ªæ½œåœ¨æ¨ç†ã€‚å½“ $x$ æ˜¯ $D$ ç»´ï¼ˆå¦‚æœ $f(x)$ æ˜¯ä¸€ç»´é«˜æ–¯ï¼Œä¸‹é¢ç»“æœä¼šæ›´å®¹æ˜“å¾—å‡ºäº†ï¼Œè¿™é‡Œä¸åšè§£é‡Šã€‚ï¼‰ï¼Œå³ ${x}\in \mathbb{R} ^D$ æ—¶ï¼Œç”±å¤šç»´é«˜æ–¯åˆ†å¸ƒ $f( \mathbf{x} ) = \frac{1}{(2\pi)^{\frac{D}{2}} | Î£ |^{\frac{1}{2}}} e^{- \frac{1}{2}( x - Î¼ )^T Î£^{-1}(x - Î¼)}$  å¯å¾—:
$$
\begin{align}
\nabla _{\tilde{x}} \log q_Ïƒ(\tilde{x}|x) &= \nabla _{\tilde{x}}(C - \frac{1}{2}(\tilde{x} - x )^T Î£^{-1}(\tilde{x} - x)) \\
&= -Î£^{-1}(\tilde{x} - x) \\
&= -\begin{bmatrix} ğœ_{1}^2 & & & \\ & ğœ_{2}^2 & & \\ & & \ddots &\\ & & &ğœ_{d}^2 \end{bmatrix}^{-1} (\tilde{x} - x) \tag{1.127}\\
&= - \frac{\tilde{x} - x}{ğœ^2} \tag{1.128} \\
&= - \frac{\epsilon}{ğœ} \tag{1.129}
\end{align}
$$
 ï¼Œå°†ï¼ˆ1.128ï¼‰ï¼ˆ1.129ï¼‰å¸¦å…¥å…¬å¼ï¼ˆ2.10ï¼‰å¯ä»¥å†™ä¸ºå¦‚ä¸‹å½¢å¼ï¼š
$$
\begin{align}
& ~~~~ \frac{1}{2}\mathbb{E}_{q_Ïƒ(\tilde{x}|x) q_{data}(x) }
\Big[\Vert s_{\theta}( \tilde{x},\sigma ) - \nabla _{\tilde{x}} \log q_Ïƒ(\tilde{x}|x)\Vert_2^2\Big] \\
&= \frac{1}{2}\mathbb{E}_{q_Ïƒ(\tilde{x}|x)}\mathbb{E}_{q_{data}(x)}
\Big[\Big\Vert s_{\theta}( \tilde{x},\sigma ) + \frac{\tilde{x}-x}{Ïƒ^2}\Big\Vert_2^2\Big] \\ 
&= \frac{1}{2}\mathbb{E}_{q_{data}(x)}\mathbb{E}_{\tilde{x} \sim \mathcal{N}(\tilde{x}|x,Ïƒ^2I)}
\Big[\Big\Vert s_{\theta}( \tilde{x},\sigma ) + \frac{\tilde{x}-x}{Ïƒ^2}\Big\Vert_2^2\Big] \tag{1.130} \\
&= \frac{1}{2}\mathbb{E}_{q_{data}(x)}\mathbb{E}_{\tilde{x} \sim \mathcal{N}(\tilde{x}|x,Ïƒ^2I)}
\Big[\Big\Vert s_{\theta}( \tilde{x},\sigma ) + \frac{\epsilon}{Ïƒ}\Big\Vert_2^2\Big]  \\
& =\mathcal{l}(\theta;\sigma) \tag{1.131}
\end{align}
$$
ä¸€æ¬æ¥è®²ï¼Œæˆ‘ä»¬æ¨å¯¼ï¼ˆ1.130ï¼‰å°±åœäº†ï¼Œä½†æ˜¯ä¸ºäº†ç»™åé¢çš„å†…å®¹æ­æ¡¥ï¼Œæˆ‘ä»¬å¤šå†™äº†ä¸€æ­¥ã€‚å…·ä½“æ€ä¹ˆä½¿ç”¨åé¢å†ä»‹ç»ã€‚å®‹é£åšå£«å®éªŒå‘ç° $s_{\theta}( \tilde{x},\sigma )$ æ­£æ¯”äº $\frac{1}{\sigma}$ ã€‚çœŸæ­£åœ¨ä½¿ç”¨æ—¶ï¼Œè®ºæ–‡ä½¿ç”¨çš„æ˜¯è¿™ä¸ªå‡½æ•°æ˜¯æŠŠé‡Œé¢çš„  $\frac{1}{\sigma}$  æå‡ºæ¥ï¼Œå¦‚ä¸‹å…¬å¼ï¼Œè¿™æ ·æœŸæœ›é‡Œé¢çš„å€¼å°±ä¸æ–¹å·®æ— å…³äº†ã€‚
$$\frac{1}{2Ïƒ^2}\mathbb{E}_{q_{data}(x)}\mathbb{E}_{\tilde{x} \sim \mathcal{N}(\tilde{x}|x,Ïƒ^2I)}
\Big[\Big\Vert Ïƒ*s_{\theta}( \tilde{x},\sigma ) + \epsilon\Big\Vert_2^2\Big]$$

![](../images/1.15.png)
ï¼ˆ $s_\theta$ ä»£è¡¨éœ€è¦è®­ç»ƒçš„å™ªå£°ï¼Œå™ªå£°åˆ†æ•°åŒ¹é…æ¨¡å‹è®­ç»ƒã€‚å›¾ç‰‡æ¥è‡ªâ€Tutorial on Diffusion Models for Imaging and Visionâ€œ ï¼‰


#### 7.2.3 é€€ç«æœ—ä¹‹ä¸‡åŠ¨åŠ›å­¦é‡‡æ ·ï¼ˆannealed Langevin dynamicsï¼‰
å½“æˆ‘ä»¬è®­ç»ƒå®Œäº†åˆ†æ•°æ¨¡å‹ $s_{\theta}(x)$ åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„é‡‡ç”¨æ–¹æ³•æ¥åšç”Ÿæˆæ¨ç†ã€‚
åœ¨7.7.2é‡Œé¢ï¼Œæˆ‘ä»¬ä»‹ç»äº†ä¸€æ­¥â€éƒä¹‹ä¸‡åŠ¨åŠ›æ–¹ç¨‹â€œçš„å™ªå£°åˆ†æ•°æ¨ç†ï¼ŒNCSN ä½¿ç”¨äº†å¤šä¸ªå™ªå£°çº§åˆ«ï¼Œæˆ‘ä»¬å°†å…¶æ¨å¹¿å¼€æ¥ã€‚
æˆ‘ä»¬æœ‰å¦‚ä¸‹è¡¨ç¤ºè¡¨ç¤ºï¼šæœ‰ $L$ ä¸ªé€’å¢çš„ $ğœ_1>ğœ_2>â‹¯>ğœ_L>0$ ï¼Œåˆ†å¸ƒ $q(X)$ ä¸æ¯ä¸ªé«˜æ–¯å™ªå£° $\sigma\epsilon \sim \mathcal{N}(0,ğœ_i^2I),i=1,2,â‹¯,L$ ç»“åˆæˆå—æ‰°åŠ¨çš„åˆ†å¸ƒã€‚è¿™é‡Œçš„Â $ğœ_L$Â è¦è¶³å¤Ÿå°ï¼Œ$ğœ_1$Â çš„å°ºåº¦å¤§æ¦‚ä¸ºæ‰€æœ‰è®­ç»ƒæ•°æ®ç‚¹ä¸¤ä¸¤ä¹‹é—´çš„æœ€å¤§è·ç¦»ï¼Œğ¿Â ä¸€èˆ¬æ˜¯å‡ ç™¾åˆ°å‡ åƒçš„èŒƒå›´ã€‚è¿™ç§é‡‡æ ·æ–¹æ³•è¶Šå¾€åï¼Œå™ªå£°è¶Šå°ï¼ˆé€€ç«ï¼‰ï¼Œæ‰€ä»¥å«é€€ç«æœ—ä¹‹ä¸‡åŠ¨åŠ›å­¦é‡‡æ ·ï¼ˆannealed Langevin dynamicsï¼‰ã€‚ç›´è§‚æ¥çœ‹ï¼ŒæŒ‰ç…§å™ªå£°é€’å‡çš„é¡ºåºæ¥é‡‡æ ·æ˜¯å› ä¸ºï¼Œä¸€å¼€å§‹å™ªå£°å…ˆå¤§ä¸€äº›ï¼Œèƒ½å¤Ÿè®©æ•°æ®å…ˆç§»åŠ¨åˆ°é«˜å¯†åº¦åŒºåŸŸï¼Œä¹‹åå™ªå£°å†å°ä¸€äº›ï¼Œå¯ä»¥è®©æ•°æ®åœ¨é«˜å¯†åº¦åŒºåŸŸèƒ½æ›´ç²¾å‡†åœ°ç§»åŠ¨åˆ°æ›´åŠ ç¬¦åˆæ•°æ®åˆ†å¸ƒçš„ä½ç½®ã€‚
å¦‚ä¸‹æ˜¯é€€ç«æœ—ä¹‹ä¸‡åŠ¨åŠ›å­¦é‡‡æ ·ï¼ˆannealed Langevin dynamicsï¼‰çš„ç®—æ³•æµç¨‹ï¼š

| é€€ç«æœ—ä¹‹ä¸‡åŠ¨åŠ›å­¦é‡‡æ ·ä¼ªä»£ç                                                                                                   |
| -------------------------------------------------------------------------------------------------------------- |
| å·²çŸ¥ï¼š$\{\sigma_i\}_{i=1}^L,\epsilon,T$                                                                           |
| 1:  åˆå§‹åŒ– $x_0$ ä¸ºéšæœºåˆ†å¸ƒ                                                                                            |
| 2:  for i=1 to L:        # æ¨¡æ‹Ÿé€€ç«ç®—æ³•ï¼Œå™ªå£°ä»å¤§åˆ°å°                                                                       |
| 3:        $\alpha_i = \epsilon \cdot \frac{\sigma_i^2}{\sigma_L^2}$     # $\alpha$ æ˜¯æ­¥é•¿ï¼Œä»å¤§åˆ°å°ã€‚ç±»ä¼¼æ¢¯åº¦ä¸‹é™ï¼Œå¼€å§‹æ‰¾æ–¹å‘ï¼Œåé¢å¾®è°ƒ  |
| 4:        for t =1 to T:  # æ¯ä¸ªæ­¥é•¿éƒ½ç»è¿‡Tæ­¥éƒä¹‹ä¸‡é‡‡æ ·                                                                     |
| 5:             Draw $z_t \sim \mathcal{N}(0,I)$                                                                |
| 6:             $x_{t}=x_{t-1}+\frac{\alpha_i}{2}s_{\theta}(x_{t-1},\sigma_i) +\sqrt{\alpha_i}\boldsymbol{z}_t$ |
| 7:        $x_0=x_t$                                                                                            |
| 8.  return $x_T$   # æ³¨æ„ï¼Œè¿™é‡Œçš„ $x_T$ä»£è¡¨çœŸå®å›¾åƒ                                                                        |

è¯¥è®ºæ–‡å‘è¡¨æ—¶é—´ç›¸å¯¹è¾ƒæ—©ï¼Œå½¼æ—¶ä¹‹ç›®çš„ä»…ä¸ºé€šè¿‡è®­ç»ƒâ€œåˆ†æ•°æ¨¡å‹â€ä»¥è®­ç»ƒç”Ÿæˆæ¨¡å‹ï¼Œå°šæ— ç°åœ¨çš„æ‰©æ•£æ¨¡å‹æ¦‚å¿µï¼ŒåŸæ–‡äº¦æœªè¿›è¡Œä¸¥æ ¼çš„å‰å‘ä¸åå‘æ“ä½œã€‚åœ¨è®ºæ–‡å¤ç°è¿‡ç¨‹ä¸­ï¼Œä¹Ÿé­é‡äº†è‹¥å¹²æ„å¤–çŠ¶å†µï¼Œè¯¸å¦‚â€œæŸå¤±å‡½æ•°ä¸æ”¶æ•›â€ã€â€œæ¨¡å‹é¢„æµ‹åˆ†æ•°ä¸ç²¾ç¡®â€ä»¥åŠâ€œç”Ÿæˆç»“æœä¸åŸå§‹æ•°æ®åˆ†å¸ƒå­˜åœ¨è¾ƒå¤§åå·®â€ç­‰é—®é¢˜ã€‚å› æ­¤ï¼Œæˆ‘ä»¬æœªå¯¹â€œæºç ä¸è®­ç»ƒè¿‡ç¨‹â€åšè¿›ä¸€æ­¥è®²è§£ã€‚

### 7.3 åŸºäºâ€åˆ†æ•°â€œä¸åŸºäºâ€å™ªå£°â€œçš„æ‰©æ•£æ¨¡å‹å…·æœ‰ç»Ÿä¸€æ€§
ä»‹ç»å®Œâ€œåˆ†æ•°â€çš„æ‰©æ•£ç”Ÿæˆæ¨¡å‹åŸºç¡€çŸ¥è¯†ï¼Œæˆ‘ä»¬å›åˆ°åŸºäºå™ªå£°çš„æ‰©æ•£æ¨¡å‹DDPMçš„ç†è®ºä¸Šã€‚æˆ‘ä»¬å¼•å…¥ Tweedie å…¬å¼ã€‚
>[!Tweedie å…¬å¼]
> Tweedie å…¬å¼æ¥è‡ªè´å¶æ–¯ä¼°è®¡ã€‚è´å¶æ–¯ä¼°è®¡çš„é—®é¢˜å®šä¹‰ä¸ºæ ¹æ®ä¸€äº›è§‚æµ‹æ•°æ®Â $ğ‘¥$Â æ¥ä¼°è®¡æœªçŸ¥å‚æ•°Â $ğœƒ$ï¼Œå¦‚æœç”¨å‡æ–¹è¯¯å·®(MSE)æŸå¤±å‡½æ•°æ¥è¡¡é‡ä¼°è®¡çš„å‡†ç¡®æ€§çš„è¯ï¼Œæˆ‘ä»¬å°†é—®é¢˜å»ºæ¨¡ä¸ºï¼š
> $$L= \mathbb{E}[(\hat{\theta}(x)-\theta)^2]$$
> æ•´ä¸ªé—®é¢˜æœ¬è´¨å…¶å®å°±æ˜¯æ±‚è§£ï¼Œ $x$ çš„æ¡ä»¶ä¸‹ï¼Œ $\theta$ å€¼çš„æœŸæœ›ï¼š
> $$\hat{\theta}(x)=\mathbb{E}[\theta|x]=\int \theta p(\theta|x)d\theta \tag{1.132}$$
> è€ŒTweedieå…¬å¼ï¼Œå°±æ˜¯ä¸€ç§ä¼°è®¡ $\theta$ çš„æ–¹æ¡ˆã€‚å‡è®¾ $p(x|\theta)=\mathcal{N}(\theta,\sigma^2)$ï¼Œå¯ä»¥é€šè¿‡è§‚æµ‹æ•°æ®ä¼°è®¡å‡ºå‚æ•°ğœï¼Œåˆ™æœ‰ï¼š
> $$\begin{align}
 \hat{\theta}(x)=\mathbb{E}[\theta|x] &=\int \theta p(\theta|x)d\theta \\
 &= x+\sigma^2\frac{d}{dx} \log p(x) \tag{1.133}
 \end{align}$$
> è¿™ä¸ªå…¬å¼çš„ä¼˜ç‚¹æ˜¯ä¸€ç›´ä¿æœ‰ç€ $ğ‘(ğœƒ)$Â çš„é›å½¢è€Œæ²¡æœ‰æ¢ç©¶å®ƒçš„å…·ä½“æ ·å­ã€‚æ­¤å…¬å¼ä¸“ä¾›å·²çŸ¥æ–¹å·®ï¼Œæ±‚ä¸å‡ºæ¥å‡å€¼æ—¶ä½¿ç”¨ã€‚ä»æ•°å­¦ä¸Šè®²ï¼Œå¯¹äºæ»¡è¶³é«˜æ–¯åˆ†å¸ƒçš„å˜é‡Â $ğ‘§ \sim \mathcal{ğ‘}(ğ‘§;Î¼_ğ‘§,Î£_ğ‘§)$ï¼ŒTweedie å…¬å¼å¦‚ä¸‹ï¼š
> $$\mathbb{E}[ğœ‡_z|z]=z+ğ›´_z âˆ‡_z \logâ¡ p(z) \tag{1.134}$$

åˆ©ç”¨Tweedie å…¬å¼æ­¤æ—¶æˆ‘ä»¬æ„é€ å‡ºäº†â€åˆ†æ•°â€œå…¬å¼ã€‚æˆ‘ä»¬ä»å‰æ–‡çš„æ¨ç† $q(x_t|x_0)=\mathcal{N}(x_t;\sqrt{\bar{\alpha}_t}x_0,(1-\bar{\alpha}_t)I)$ å¼€å§‹ï¼Œå°è¯•å°†ä¸Šé¢çš„æ¨è®ºç”¨åˆ°ä¹‹å‰VDMçš„æ¨ç†ã€‚åˆ©ç”¨Tweedieå…¬å¼ï¼Œæˆ‘ä»¬å¾—å‡ºï¼š
$$\mathbb{ğ¸}[ğœ‡_{x_t}|x_t]=x_t+(1-\bar{\alpha}_t)âˆ‡_{x_t} \logâ¡ ğ‘(x_t) \tag{1.135}$$

è¿™ä¹ˆåšçš„ç›®çš„æ˜¯æˆ‘ä»¬å‘ç°å…¬å¼ $q(x_t|x_0)=\mathcal{N}(x_t;\sqrt{\bar{\alpha}_t}x_0,(1-\bar{\alpha}_t)I)$  é‡Œé¢â€œæ–¹å·®å¾ˆå¥½æ±‚ï¼Œå‡å€¼å¤ªéš¾æ±‚ï¼ˆå› ä¸ºæœ‰$x_0$ï¼‰â€œã€‚æˆ‘ä»¬æœ‰å¿…è¦é¿å…è¾ƒå°‘å¯¹å‡å€¼çš„çš„ä½¿ç”¨ï¼Œå¦‚æœ‰å¿…è¦è¿˜éœ€è¦å¯¹å‡å€¼ç»™å‡ºä¸€ç§æ–°çš„å½¢å¼ã€‚ä¸ºäº†ç¬¦å·çš„ç®€æ´æ€§ï¼Œæˆ‘ä»¬å°† $âˆ‡_{x_t}\log p(x_t)$ å†™ä¸º $âˆ‡ \log p(x_t)$Â ã€‚æ ¹æ® Tweedie å…¬å¼ï¼Œç”± $ğ‘¥_ğ‘¡$ ç”Ÿæˆçš„çœŸå®å‡å€¼ $Î¼_{ğ‘¥_ğ‘¡}=\sqrt{\bar{Î±}_t}ğ‘¥_0$ ï¼Œå¯å®šä¹‰ä¸ºï¼š
$$
\begin{align}
\sqrt{\bar{Î±}_t}ğ‘¥_0 &= x_t+(1-\bar{\alpha}_t)âˆ‡_{x_t} \logâ¡ ğ‘(x_t) \tag{1.136} \\
\therefore x_0 &= \frac{x_t+(1-\bar{\alpha}_t)âˆ‡_{x_t} \logâ¡ ğ‘(x_t)} {\sqrt{\bar{Î±}_t}} \tag{1.137}
\end{align}
$$
ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¬å¼ï¼ˆ1.137ï¼‰å†æ¬¡ä»£å…¥æˆ‘ä»¬çš„çœŸå®å»å™ªè½¬ç§»å‡å€¼ $Î¼_ğ‘(ğ‘¥_ğ‘¡,ğ‘¥_0)$å¹¶æ¨å¯¼å‡ºæ–°çš„å½¢å¼ï¼š
$$
\begin{align}
\mu_q(x_t,x_0) &=\frac{\sqrt{{\alpha}_t}(1-\bar{{\alpha}}_{t-1}){{x}}_t+\sqrt{\bar{{\alpha}}_{t-1}}(1-{\alpha}_t){{x}}_{0}}{1-\bar{{\alpha}}_{t}} 
\tag{1.138} \\
&= \frac{\sqrt{{\alpha}_t}(1-\bar{{\alpha}}_{t-1}){{x}}_t+\sqrt{\bar{{\alpha}}_{t-1}}(1-{\alpha}_t)\frac{x_t+(1-\bar{\alpha}_t)âˆ‡_{x_t} \logâ¡ ğ‘(x_t)} {\sqrt{\bar{Î±}_t}} }{1-\bar{{\alpha}}_{t}}  \\
&= \frac{\sqrt{{\alpha}_t}(1-\bar{{\alpha}}_{t-1}){{x}}_t+(1-{\alpha}_t)\frac{x_t+(1-\bar{\alpha}_t)âˆ‡_{x_t} \logâ¡ ğ‘(x_t)} {\sqrt{Î±_t}} }{1-\bar{\alpha}_{t}} \\
&= \frac{\sqrt{{\alpha}_t}(1-\bar{{\alpha}}_{t-1}){{x}}_t}{1-\bar{\alpha}_{t}} +
\frac{(1-{\alpha}_t)x_t}{(1-\bar{\alpha}_{t})\sqrt{Î±_t}} + \frac{(1-\alpha_t)(1-\bar{\alpha}_t)âˆ‡_{x_t} \logâ¡ ğ‘(x_t) }{(1-\bar{\alpha}_{t})\sqrt{Î±_t}}  \\
&= \Big(\frac{\sqrt{{\alpha}_t}(1-\bar{{\alpha}}_{t-1})}{1-\bar{\alpha}_{t}} +
\frac{1-{\alpha}_t}{(1-\bar{\alpha}_{t})\sqrt{Î±_t}} \Big)x_t+ \frac{1-\alpha_t}{\sqrt{Î±_t}}âˆ‡_{x_t} \logâ¡ ğ‘(x_t)  \\
&= \Big(\frac{{\alpha}_t(1-\bar{{\alpha}}_{t-1})}{(1-\bar{\alpha}_{t})\sqrt{{\alpha}_t}} +
\frac{1-{\alpha}_t}{(1-\bar{\alpha}_{t})\sqrt{Î±_t}} \Big)x_t+ \frac{1-\alpha_t}{\sqrt{Î±_t}}âˆ‡_{x_t} \logâ¡ ğ‘(x_t) \\
&= \frac{{\alpha}_t -\bar{{\alpha}}_{t}+ 1-{\alpha}_t}{(1-\bar{\alpha}_{t})\sqrt{Î±_t}}x_t+ \frac{1-\alpha_t}{\sqrt{Î±_t}}âˆ‡_{x_t} \logâ¡ ğ‘(x_t)  \\
&= \frac{ 1-\bar{{\alpha}}_{t}}{(1-\bar{\alpha}_{t})\sqrt{Î±_t}}x_t+ \frac{1-\alpha_t}{\sqrt{Î±_t}}âˆ‡_{x_t} \logâ¡ ğ‘(x_t) \\
&= \frac{ 1}{\sqrt{Î±_t}}x_t+ \frac{1-\alpha_t}{\sqrt{Î±_t}}âˆ‡_{x_t} \logâ¡ ğ‘(x_t) \tag{1.139} \\
\end{align}
$$
å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®è¿‘è§†å»å™ªå‡å€¼ $\mu_\theta(x_t,t)$ ä¸ºï¼š
$$
\mu_\theta(x_t,t) = \frac{1}{\sqrt{\alpha_t}}x_t - \frac{1-{\alpha}_t}{\sqrt{1-\bar{{\alpha}}_t}\sqrt{\alpha_t}}s_\theta(x_t,t) \tag{1.140}
$$
ç›¸åº”çš„ä¼˜åŒ–é—®é¢˜å¯ä»¥å˜ä¸ºï¼š
$$
\begin{align}
&~~~~\arg\min_{{{\theta}}} D_{\text{KL}}(q({{x}}_{t-1}|{{x}}_t,{{x}}_0)\Vert p_{{\theta}}({{x}}_{t-1}|{{x}}_t))\\
&=\arg\min_{{{\theta}}} D_{\text{KL}}(\mathcal{N} ({{x}}_{t-1}; Î¼_q, Î£_q(t)) \Vert \mathcal{N} ({{x}}_{t-1}; Î¼_{{\theta}}, Î£_q(t))) \tag{1.141} \\
&=\arg\min_{{{\theta}}} \frac{1}{2Ïƒ_q^2 (t)} \left[ \Big\Vert \frac{1}{\sqrt{\alpha_t}}x_t + \frac{1-{\alpha}_t}{\sqrt{\alpha_t}}s_\theta(x_t,t) âˆ’ \frac{1}{\sqrt{\alpha_t}}x_t - \frac{1-{\alpha}_t}{\sqrt{\alpha_t}}âˆ‡_{x_t} \logâ¡ ğ‘(x_t)\Big\Vert_2^2 \right]  \\
&=\arg\min_{{{\theta}}} \frac{1}{2Ïƒ_q^2 (t)} \left[ \Big\Vert  \frac{1-{\alpha}_t}{\sqrt{\alpha_t}}s_\theta(x_t,t) - \frac{1-{\alpha}_t}{\sqrt{\alpha_t}}âˆ‡_{x_t} \logâ¡ ğ‘(x_t)\Big\Vert_2^2 \right] \\
&=\arg\min_{{{\theta}}} \frac{1}{2Ïƒ_q^2 (t)} \left[ \Big\Vert  \frac{1-{\alpha}_t}{\sqrt{\alpha_t}}(s_\theta(x_t,t) - âˆ‡_{x_t} \logâ¡ ğ‘(x_t))\Big\Vert_2^2 \right] \\
&=\arg\min_{{{\theta}}} \frac{1}{2Ïƒ_q^2 (t)} \frac{(1-{\alpha}_t)^2}{\alpha_t} \left[\Vert s_\theta(x_t,t) - âˆ‡_{x_t} \logâ¡ ğ‘(x_t)\Vert_2^2 \right] \tag{1.142} \\
\end{align}
$$
è¿™é‡Œï¼Œ$s_Î¸(x_t, t)$ å¯ä»¥æ˜¯ä¸€ä¸ªç¥ç»ç½‘ç»œï¼Œç”¨æ¥å­¦ä¹ é¢„æµ‹åˆ†æ•°å‡½æ•°ï¼ˆscore functionï¼‰ $âˆ‡_{x_t} \log  p(x_t)$ã€‚ $âˆ‡_{x_t} \log  p(x_t)$ å°±æ˜¯åˆ†æ•°å‡½æ•°ï¼Œ å…¶æ€§è´¨åé¢ä¼šè¯¦ç»†é˜è¿°ã€‚æ•é”çš„è¯»è€…ä¼šæ³¨æ„åˆ°ï¼Œåˆ†æ•°å‡½æ•° $âˆ‡ \logâ¡ p(x_t)$ åœ¨å½¢å¼ä¸Šä¸æºå™ªå£° $ğœ–_0$ éå¸¸ç›¸ä¼¼ã€‚å°†Tweedieå…¬å¼ï¼ˆ1.137ï¼‰ä¸é‡å‚æ•°åŒ–æŠ€å·§å…¬å¼ï¼ˆ1.111ï¼‰ç»“åˆèµ·æ¥ï¼Œå¯ä»¥æ˜ç¡®åœ°å±•ç¤ºè¿™ä¸€ç‚¹ï¼š
$$
\begin{align}
x_0 = \frac{x_t+(1-\bar{\alpha}_t)âˆ‡_{x_t} \logâ¡ ğ‘(x_t)} {\sqrt{\bar{Î±}_t}} &= \frac{x_t-\sqrt{1-\bar{\alpha}_t}\epsilon_0}{\sqrt{\bar{\alpha}_t}} \tag{1.143} \\
\therefore (1-\bar{\alpha}_t)âˆ‡_{x_t} \logâ¡ ğ‘(x_t) &= -\sqrt{1-\bar{\alpha}_t}\epsilon_0 \tag{1.144} \\
âˆ‡_{x_t} \logâ¡ ğ‘(x_t) &= - \frac{1}{\sqrt{1-\bar{\alpha}_t}}\epsilon_0 \tag{1.145} \\
\end{align}
$$
å› ä¸ºæ˜¯æ ‡å‡†æ­£æ€åˆ†å¸ƒï¼Œè¿™é‡Œçš„ $\epsilon_0$ çš„ä¸‹è§’æ ‡å·²ç»æ— æ„ä¹‰ï¼Œä¸ç®¡æ˜¯ä»éƒä¹‹ä¸‡å…¬å¼å¾—åˆ°çš„å…¬å¼ï¼ˆ1.128ï¼‰
$$
\begin{align}
\nabla _{\tilde{x}} \log q_Ïƒ(\tilde{x}|x) &= - \frac{\epsilon}{ğœ} \\
q(x_t|x_0)&=\mathcal{N}(x_t;\sqrt{\bar{\alpha}_t}x_0,(1-\bar{\alpha}_t)I)
\end{align}
$$
è¿˜æ˜¯Tweedieå…¬å¼å¾—åˆ°çš„ $âˆ‡_{x_t} \logâ¡ ğ‘(x_t) = - \frac{1}{\sqrt{1-\bar{\alpha}_t}}\epsilon_0$ æˆ‘ä»¬éƒ½èƒ½å¾—åˆ°
$$
\arg\min_{{{\theta}}} D_{\text{KL}}(q({{x}}_{t-1}|{{x}}_t,{{x}}_0)\Vert p_{{\theta}}({{x}}_{t-1}|{{x}}_t)) = \arg\min_{{{\theta}}} \frac{1}{2Ïƒ_q^2 (t)} \frac{(1-{\alpha}_t)^2}{\alpha_t} \left[\Vert s_\theta(x_t,t) + \frac{1}{\sqrt{1-\bar{\alpha}_t}}\epsilon_0 \Vert_2^2 \right]
$$
ä»ç›®å‰æ¥è®²ï¼Œæˆ‘ä»¬ç”¨æ•°å­¦è¯æ˜è¯å®äº†ï¼šå­¦ä¹ ç¥ç»ç½‘ç»œé¢„æµ‹åŸå§‹å›¾åƒ $ğ‘¥_0$ï¼›å­¦ä¹ ç¥ç»ç½‘ç»œé¢„æµ‹æºå™ªå£°Â $ğœ–_0$ï¼›å­¦ä¹ ä¸€å®šå™ªå£°æ°´å¹³ä¸‹çš„å›¾åƒåˆ†æ•°å‡½æ•° $âˆ‡ \logâ¡ p(x_t)$ã€‚éƒ½å¯ä»¥ä¼˜åŒ–VDMå‡½æ•°ã€‚æˆ‘ä»¬åœ¨çœ‹è®ºæ–‡æ—¶å¦‚æœé‡åˆ°æŸäº›äººç”¨ä¸€ç§æ–¹æ³•æ¨ç†ï¼Œè¯·ä¸è¦æƒŠæ…Œã€‚å…¶å®å†…éƒ¨åŸç†æ˜¯ä¸€æ ·çš„ã€‚



[1] Jonathan Ho, Ajay Jain, Pieter Abbeel. Denoising Diffusion Probabilistic Models. arXiv preprint  arXiv:2006.11239v2.
[2] Yang Song, Jascha Sohl-Dickstein, Diederik P. Kingma, Abhishek Kumar, Stefano Ermon, Ben Poole. Score-Based Generative Modeling through Stochastic Differential Equations. arXiv:2011.13456
[3] Yang Song, and Stefano Ermon. Generative Modeling by Estimating Gradients of the Data Distribution. arXiv:1907.05600
[4] Pascal Vincent. A Connection Between Score Matching and Denoising Autoencoders