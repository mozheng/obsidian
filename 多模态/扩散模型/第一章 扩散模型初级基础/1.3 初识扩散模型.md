### 1.3.1 扩散模型概述

扩散模型是继生成对抗网络（GAN）后，在图像合成领域表现更好的生成模型。扩散模型算法是一种受到热力学中非平衡热力学分支启发的算法，其思想来源是扩散过程。“扩散”的含义很形象，就像一幅在水中用染色剂画的简笔画。简笔画落在水中会慢慢扩散开，最后达到完全模糊。扩散模型也是使用这样的原理。“简笔画在水面的扩散过程”可以类比为在图像中持续加入噪声信息。噪声逐渐增加直至图像完全被噪声覆盖的过程，就是我们模拟出图像逐渐模糊的效果。反过来考虑，如果我们从噪声信息出发，不断地有指向性地去噪，就可以生成有意义的图片了。

![](../images/1.13.png)
（树状彩色染色剂在水中开始扩散，图片由FLUX生成）

上述的扩散过程在我们这里的表示如下：通过深度学习方法从纯噪声数据逐渐对数据进行去噪的过程，从单个图像样来看这个过程，扩散过程q就是不断往图像上加噪声直到图像变成一个纯噪声。扩散过程从开始的0到最后的 $T$ 或从最后的 $T$ 到开始的0可以看成马尔可夫链结构，中间的 $p，q$ 操作可以表示状态空间中经过从一个状态到另一个状态的转换的随机过程。逆扩散过程 $p$ 就是从纯噪声生成一张图像的过程。
![](../images/1.14.jpg)
(扩散模型过程简述)

在后续的逻辑推演过程中，我们将以基础的数学公式为起点，运用相当于大学三年级水平的理论知识进行深入的推导。（值得注意的是，在某些省份，这些知识内容可能已经被包含在高中课程中）此举旨在使读者能够全面理解扩散模型的整个推理过程。鉴于扩散模型的公式具有一定的复杂性，对于那些更倾向于工程应用而非理论探索的工程型读者，我们建议不必过分纠结于具体的推理细节，只需了解“在特定情境下，公式的输入与输出分别是什么”即可。

### 1.3.2 扩散模型内容流程简介
扩散模型的内容十分复杂。在介绍前，请允许我用思维导图梳理整个流程。扩散模型目前有多种解释方法：**基于噪声的扩散模型（DDPM），基于分数的扩散模型（SMLD），基于随机微分方程（SDE）的扩散模型**。三者本质一样，但建议都要了解一下，因为这里边有一套非常复杂的逻辑：
- “基于噪声的扩散模型”和“基于分数的扩散模型”本质一体，两者有转换公式。
- “基于噪声的扩散模型”和“基于分数的扩散模型”同时也是“基于随机微分方程的扩散模型”的一个特解。我们可以用“基于随机微分方程的扩散模型”的随机微分方程（SDE）解释扩散模型的全部过程。
- 宋飏博士将两者统一到随机微分方程SDE形式后，优化方案完全按照SDE的数学形式进行推理了。但是推理的过程不免于参考原始的“基于噪声的扩散模型”和“基于分数的扩散模型”公式。
因此，我提供一个思维导图，简述一下扩散模型基础内容与逻辑关系。后面我还会详细延展各个部分。

![](../images/扩散模型初级基础.jpg)
(扩散模型基础知识结构)

我们可以根据思维导图，上到下构建扩散模型的知识结构。
- 1. **基于噪声的扩散模型**：去噪扩散概率模型（Denoising Diffusion Probabilistic Models，DDPM）的核心思想在于，它首先将数据逐渐转化为噪声，然后通过训练一个模型来逆向执行这一过程，从而生成新的数据样本。DDPM通过逐层引入噪声并逐层去噪的过程来生成数据。这里的“逐层”的概念，就是多层VAE叠加结构，也是DDPM主干结构（VDM）。所以本文从单层VAE结构开始讲起，逐渐构建出DDPM整体结构。
- 2. **基于分数的扩散模型**：分数匹配郎之万动力方程扩散模型（Score-Matching Langevin Dynamics，SMLD）是一个比DDPM还要早的生成模型，其核心思想是通过**分数匹配**技术训练神经网络来近似数据分布的梯度（即“分数函数”），再通过**郎之万动力方程**生成新的数据样本。通过SMLD的应用，能够更高效地从复杂的噪声分布中恢复出原始数据分布，确保生成数据的高质量。因此，在构建DDPM的整体框架时，深入理解和有效运用SMLD技术也显得尤为重要。
- 3. **基于随机微分方程的扩散模型**：随机微分过程（Stochastic Differential Equation，SDE）是描述随机过程随时间演变的一种数学模型。在扩散模型中，SDE被用来描述数据如何在连续时间域内从一个初始分布逐渐扩散到一个复杂的噪声分布。这个扩散过程可以通过反向过程来逆转，即从噪声分布中生成高质量的数据样本。整体思路与之前的DDPM扩散模型一致，但SDE的能力不止如此，它是DDPM，SMLD的通解。这也意味着DDPM和SLMD有对应的SDE形式。在后续的论文中，算法优化和时间优化等方法，都基于这些随机微分方程推理公式进行合理推理。

由此，我们可以列出如下完整的表，将他们这些概念整合到一起。

|          |                           正向扩散过程SDE                           |                                                                                     逆向扩散过程SDE                                                                                     |
| :------: | :-----------------------------------------------------------: | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------: |
|   SDE    |                伊藤公式：$dx_t = f(x,t)dt+ g(t)dw$                 |                                                               Anderson公式：$dx=[f(x,t)-g^2(t)s_\theta(x_t)]dt+g(t)dw$                                                               |
| DDPM微分方程 | $dx=d(Fx)=-\frac{1}{2}F\beta(t)Fx(t)dt + \sqrt{ F\beta(t)}dw$ |                           $dx=d(Fx)=[-\frac{1}{2}F\beta(t)Fx(t)+ F\beta(t)(\frac{1}{\sqrt{1-\bar{\alpha}_i}}\epsilon_0)]dt + \sqrt{ F\beta(t)}d\bar{w}$                           |
| DDPM迭代方程 |  $x_i = \sqrt{1- \beta_i}x_{i-1} + \sqrt{\beta_i}\epsilon_i$  | $x_{i-1}=\frac{1}{\sqrt{1-\beta_i}}[x_i + \beta_i s_\theta(x_i)] + \sqrt{\beta_i}\epsilon_i$或$x_{i-1}=(2-\sqrt{1-\beta_i})x_i + \beta_i s_\theta(x_i) + \sqrt{\beta_i}\epsilon_i$ |
| SMLD微分方程 |           $dx=\sqrt{\frac{d[F\sigma(t)^2]}{dt}}dw$            |                                           $dx=-[\frac{d[F\sigma(t)^2]}{dt}s_\theta(Fx(t))]dt+\sqrt{\frac{d[F\sigma(t)^2]}{dt}}d\bar{w}$                                           |
| SMLD迭代方程 | $x_i=x_{i-1}+\sqrt{\sigma_i^2-\sigma_{i-1}^2}\epsilon_{i-1}$  |                                       $x_{i-1} = x_i + (\sigma_i^2-\sigma_{i-1}^2)s_\theta(x_i)+\sqrt{\sigma_i^2-\sigma_{i-1}^2}\epsilon_i$                                       |

鉴于扩散模型的构建过程相当复杂，我们将从核心**变分自编码器（VAE**）开始，逐步完成扩散模型基础知识点的搭建。鉴于这些部分内容是全书的核心，我们不会像介绍生成对抗网络（GAN）那样进行简略的阐述，而是将详细解析扩散模型的构建过程。